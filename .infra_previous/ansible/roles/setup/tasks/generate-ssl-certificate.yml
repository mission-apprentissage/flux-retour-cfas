- name: Check if SSL certificate has been generated
  stat: path=/opt/flux-retour-cfas/data/ssl/privkey.pem
  register: ssl

- name: Generate SSL certificate with LetsEncrypt
  shell: "bash /opt/flux-retour-cfas/tools/ssl/generate-certificate.sh {{dns_name}}"
  register: output
  when: ssl.stat.exists == False

- debug:
    var: output
  when: ssl.stat.exists == True

- name: Add cron to ensure SSL certificate will be renewed
  ansible.builtin.cron:
    name: "renew ssl certificate each monday at 02h00"
    minute: "0"
    hour: "2"
    weekday: "1"
    job: "bash /opt/flux-retour-cfas/tools/ssl/renew-certificate.sh {{dns_name}} >> /var/log/renew-ssl.log 2>&1"
